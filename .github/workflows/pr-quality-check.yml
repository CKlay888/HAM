# HAM ä»£ç è´¨é‡æ£€æŸ¥ - Pull Request è‡ªåŠ¨è§¦å‘
# 
# æµç¨‹ï¼š
# 1. å‘˜å·¥ push ä»£ç åˆ°åˆ†æ”¯
# 2. åˆ›å»º Pull Request
# 3. GitHub Actions è‡ªåŠ¨è¿è¡Œæ­¤æ£€æŸ¥
# 4. å…¨éƒ¨é€šè¿‡åï¼ŒColin å¯ä»¥ Merge

name: ğŸ” PR Quality Check

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

# å–æ¶ˆåŒä¸€ PR çš„æ—§è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ==========================================
  # åç«¯æ£€æŸ¥
  # ==========================================
  backend-check:
    name: ğŸ”§ åç«¯æ£€æŸ¥
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ä»£ç è§„èŒƒæ£€æŸ¥ (ESLint)
        run: npm run lint
        continue-on-error: false

      - name: ğŸ”¨ TypeScript ç¼–è¯‘
        run: npm run build

      - name: ğŸ§ª å•å…ƒæµ‹è¯•
        run: npm run test -- --passWithNoTests

      - name: ğŸ“Š æµ‹è¯•è¦†ç›–ç‡
        run: npm run test:cov -- --passWithNoTests
        continue-on-error: true

      - name: ğŸ“ˆ æ£€æŸ¥è¦†ç›–ç‡é˜ˆå€¼
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            coverage=$(cat coverage/coverage-summary.json | jq '.total.lines.pct // 0')
            echo "ä»£ç è¦†ç›–ç‡: $coverage%"
            if (( $(echo "$coverage < 50" | bc -l) )); then
              echo "âš ï¸ è¦†ç›–ç‡ä½äº 50%ï¼Œå»ºè®®è¡¥å……æµ‹è¯•"
            fi
          else
            echo "âš ï¸ æ— è¦†ç›–ç‡æŠ¥å‘Š"
          fi
        continue-on-error: true

  # ==========================================
  # å‰ç«¯æ£€æŸ¥
  # ==========================================
  frontend-check:
    name: ğŸ’¡ å‰ç«¯æ£€æŸ¥
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ä»£ç è§„èŒƒæ£€æŸ¥ (ESLint)
        run: npm run lint
        continue-on-error: true  # Next.js lint å¯èƒ½æœ‰è­¦å‘Š

      - name: ğŸ”¨ Next.js æ„å»º
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

  # ==========================================
  # å®‰å…¨æ£€æŸ¥
  # ==========================================
  security-check:
    name: ğŸ”’ å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²
        run: |
          echo "æ£€æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿä¿¡æ¯..."
          
          # æ£€æŸ¥å¸¸è§æ•æ„Ÿè¯
          if grep -rn "password\s*=\s*['\"]" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules | grep -v ".env"; then
            echo "âš ï¸ å‘ç°ç¡¬ç¼–ç å¯†ç "
          fi
          
          if grep -rn "sk-ant-\|sk-\|ghp_\|gho_" --include="*.ts" --include="*.tsx" --include="*.js" . | grep -v node_modules; then
            echo "âŒ å‘ç° API Key æ³„éœ²ï¼"
            exit 1
          fi
          
          echo "âœ… æœªå‘ç°æ˜æ˜¾æ•æ„Ÿä¿¡æ¯æ³„éœ²"

      - name: ğŸ” ä¾èµ–æ¼æ´æ£€æŸ¥ (åç«¯)
        run: |
          cd backend
          npm audit --audit-level=high || true
        continue-on-error: true

      - name: ğŸ” ä¾èµ–æ¼æ´æ£€æŸ¥ (å‰ç«¯)
        run: |
          cd frontend
          npm audit --audit-level=high || true
        continue-on-error: true

  # ==========================================
  # è´¨é‡æŠ¥å‘Š
  # ==========================================
  quality-report:
    name: ğŸ“‹ è´¨é‡æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [backend-check, frontend-check, security-check]
    if: always()
    
    steps:
      - name: ğŸ“Š ç”ŸæˆæŠ¥å‘Š
        run: |
          echo "## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.backend-check.result }}" == "success" ]; then
            echo "| ğŸ”§ åç«¯æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ”§ åç«¯æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.frontend-check.result }}" == "success" ]; then
            echo "| ğŸ’¡ å‰ç«¯æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ’¡ å‰ç«¯æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.security-check.result }}" == "success" ]; then
            echo "| ğŸ”’ å®‰å…¨æ£€æŸ¥ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ”’ å®‰å…¨æ£€æŸ¥ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“… æ£€æŸ¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: âœ… æ£€æŸ¥æ˜¯å¦å…¨éƒ¨é€šè¿‡
        if: needs.backend-check.result != 'success' || needs.frontend-check.result != 'success' || needs.security-check.result != 'success'
        run: |
          echo "âŒ æœ‰æ£€æŸ¥é¡¹æœªé€šè¿‡ï¼Œè¯·ä¿®å¤åé‡æ–°æäº¤"
          exit 1
